<?php
$this->_var['pagecss'][] = $this->_var['TMPL_REAL']."/css/style.css";
$this->_var['pagecss'][] = $this->_var['TMPL_REAL']."/css/index.css";
$this->_var['pagecss'][] = $this->_var['TMPL_REAL']."/css/utils/weebox.css";
$this->_var['pagecss'][] = $this->_var['TMPL_REAL']."/css/utils/fanweUI.css";
$this->_var['pagecss'][] = $this->_var['TMPL_REAL']."/css/zone.css";
$this->_var['pagecss'][] = $this->_var['TMPL_REAL']."/css/goods_item.css";

$this->_var['pagejs'][] = $this->_var['TMPL_REAL']."/js/utils/jquery.js";
$this->_var['pagejs'][] = $this->_var['TMPL_REAL']."/js/utils/jquery.bgiframe.js";
$this->_var['pagejs'][] = $this->_var['TMPL_REAL']."/js/utils/jquery.weebox.js";
$this->_var['pagejs'][] = $this->_var['TMPL_REAL']."/js/utils/jquery.pngfix.js";
$this->_var['pagejs'][] = $this->_var['TMPL_REAL']."/js/utils/jquery.animateToClass.js";
$this->_var['pagejs'][] = $this->_var['TMPL_REAL']."/js/utils/jquery.timer.js";
$this->_var['pagejs'][] = $this->_var['TMPL_REAL']."/js/utils/jquery.SuperSlide.2.1.js";
$this->_var['pagejs'][] = $this->_var['TMPL_REAL']."/js/utils/lazyload.js";
$this->_var['pagejs'][] = $this->_var['TMPL_REAL']."/js/fanwe_utils/fanweUI.js";
$this->_var['cpagejs'][] = $this->_var['TMPL_REAL']."/js/fanwe_utils/fanweUI.js";

$this->_var['pagejs'][] = $this->_var['TMPL_REAL']."/js/script.js";
$this->_var['cpagejs'][] = $this->_var['TMPL_REAL']."/js/script.js";
$this->_var['pagejs'][] = $this->_var['TMPL_REAL']."/js/login_panel.js";
$this->_var['cpagejs'][] = $this->_var['TMPL_REAL']."/js/login_panel.js";
$this->_var['pagejs'][] = $this->_var['TMPL_REAL']."/js/page_js/index.js";
$this->_var['cpagejs'][] = $this->_var['TMPL_REAL']."/js/page_js/index.js";
$this->_var['pagejs'][] = $this->_var['TMPL_REAL']."/dc/js/page_js/slider.js";
$this->_var['cpagejs'][] = $this->_var['TMPL_REAL']."/dc/js/page_js/slider.js";
$this->_var['pagecss'][] = $this->_var['TMPL_REAL']."/css/styletrun.css";

$this->_var['pagejs'][] = $this->_var['TMPL_REAL']."/js/jquery.eraser.js";
?>
{include file="inc/header.html"}

<style>

    #lottery{width:950px;height:640px;margin:0px auto;border:4px solid #ba1809;}
    #lottery table{width:100%;background-image:url({$TMPL}/images/truntable/img/timg3.jpg);}
    #lottery table td{position:relative;width:190px;height:160px;text-align:center;color:#333;font-index:-999;
        /*background:url("./img/back.jpg");*/
    }
    #lottery table td p{
        font-size: 20px;
        color: rgb(255, 164, 133);
        margin: 0px;

    }
    /*#lottery table td img{display:block;width:190px;height:170px;}*/
    #lottery table td a{width:190px;height:170px;display:block;text-decoration:none;}
    #lottery table td a:hover{background-image:url({$TMPL}/images/truntable/img/11.jpg);}
    #lottery table td a.choujiang-ab:hover{background-image:url({$TMPL}/images/truntable/img//11y.jpg);}
    #lottery table td a.choujiang-ac:hover{background-image:url({$TMPL}/images/truntable/img//11wu.jpg);}
    #lottery table td.active .mask{display:block;}
    #lottery table td.choujiang-a{
        width:190px;
        height:170px;
        position:relative;
        /*left:10px;*/

    }
    #lottery table td a.choujiang-ab{
        width:190px;
        height:170px;
        position:absolute;
        left:75px;
        top:140px;
        background:url({$TMPL}/images/truntable/img/9y.jpg) no-repeat top center;

    }
    #lottery table td a.choujiang-ac{
        width:190px;
        height:170px;
        position:absolute;
        left:125px;
        top:140px;
        background:url({$TMPL}/images/truntable/img/9wu.jpg) no-repeat top center;
    }
    .mask{
        width:100%;
        height:100%;
        position:absolute;
        left:0;
        top:0;
        background-color: rgba(252,211,4,0.5);
        display:none;
    }
</style>



<div class="wrap_full_w clearfix">

    <select class="box" onchange="window.location=this.value">
        {foreach from=$actitys item=item}
        {if $item.id eq $actityid}
        <option selected=true value="{url r="index" b="turntable#index"  }&actityid={$item.id}">{$item.name}</option>
        {else}
        <option value="{url r="index" b="turntable#index"  }&actityid={$item.id}">{$item.name}</option>
        {/if}
        {/foreach}
    </select>
    <div id="lottery">
        <table border="0" cellpadding="0" cellspacing="0">
            <tr>
                <td class="lottery-unit lottery-unit-0">{if isset($prize[0]['showimg'])}<img src="{function name="get_spec_image" v=$prize[0]['showimg'] w=161 h=161 g=1}" width="161" height="120">{else}<img src="{$TMPL}/images/truntable/img/{$prize[0].img}">{/if}<p><b>{$prize[0].abbrename}</b></p><div class="mask"></div></td>
                <td class="lottery-unit lottery-unit-1">{if isset($prize[1]['showimg'])}<img src="{function name="get_spec_image" v=$prize[1]['showimg'] w=161 h=161 g=1}" width="161" height="120">{else}<img src="{$TMPL}/images/truntable/img/{$prize[1].img}">{/if}<p><b>{$prize[1].abbrename}</b></p><div class="mask"></div></td>
                <td class="lottery-unit lottery-unit-2">{if isset($prize[2]['showimg'])}<img src="{function name="get_spec_image" v=$prize[2]['showimg'] w=161 h=161 g=1}" width="161" height="120">{else}<img src="{$TMPL}/images/truntable/img/{$prize[2].img}">{/if}<p><b>{$prize[2].abbrename}</b></p><div class="mask"></div></td>
                <td class="lottery-unit lottery-unit-3">{if isset($prize[3]['showimg'])}<img src="{function name="get_spec_image" v=$prize[3]['showimg'] w=161 h=161 g=1}" width="161" height="120">{else}<img src="{$TMPL}/images/truntable/img/{$prize[3].img}">{/if}<p><b>{$prize[3].abbrename}</b></p><div class="mask"></div></td>
                <td class="lottery-unit lottery-unit-4">{if isset($prize[4]['showimg'])}<img src="{function name="get_spec_image" v=$prize[4]['showimg'] w=161 h=161 g=1}" width="161" height="120">{else}<img src="{$TMPL}/images/truntable/img/{$prize[4].img}">{/if}<p><b>{$prize[4].abbrename}</b></p><div class="mask"></div></td>
            </tr>
            <tr>
                <td class="lottery-unit lottery-unit-13">{if isset($prize[13]['showimg'])}<img src="{function name="get_spec_image" v=$prize[13]['showimg'] w=161 h=161 g=1}" width="161" height="120">{else}<img src="{$TMPL}/images/truntable/img/{$prize[13].img}">{/if}<p><b>{$prize[13].abbrename}</b></p><div class="mask"></div></td>
                <td colspan="1" rowspan="2" class="choujiang-a"><a href="#" class="choujiang-ab"></a></td>
                <td colspan="2" rowspan="2" class="choujiang-a"><a href="#" class="choujiang-ac"></a></td>
                <td class="lottery-unit lottery-unit-5">{if isset($prize[5]['showimg'])}<img src="{function name="get_spec_image" v=$prize[5]['showimg'] w=161 h=161 g=1}" width="161" height="120">{else}<img src="{$TMPL}/images/truntable/img/{$prize[5].img}">{/if}<p><b>{$prize[5].abbrename}</b></p><div class="mask"></div></td>
            </tr>
            <tr>
                <td class="lottery-unit lottery-unit-12">{if isset($prize[12]['showimg'])}<img src="{function name="get_spec_image" v=$prize[12]['showimg'] w=161 h=161 g=1}" width="161" height="120">{else}<img src="{$TMPL}/images/truntable/img/{$prize[12].img}">{/if}<p><b>{$prize[12].abbrename}</b></p><div class="mask"></div></td>
                <td class="lottery-unit lottery-unit-6">{if isset($prize[6]['showimg'])}<img src="{function name="get_spec_image" v=$prize[6]['showimg'] w=161 h=161 g=1}" width="161" height="120">{else}<img src="{$TMPL}/images/truntable/img/{$prize[6].img}">{/if}<p><b>{$prize[6].abbrename}</b></p><div class="mask"></div></td>
            </tr>
            <tr>
                <td class="lottery-unit lottery-unit-11">{if isset($prize[11]['showimg'])}<img src="{function name="get_spec_image" v=$prize[11]['showimg'] w=161 h=161 g=1}" width="161" height="120">{else}<img src="{$TMPL}/images/truntable/img/{$prize[11].img}">{/if}<p><b>{$prize[11].abbrename}</b></p><div class="mask"></div></td>
                <td class="lottery-unit lottery-unit-10">{if isset($prize[10]['showimg'])}<img src="{function name="get_spec_image" v=$prize[10]['showimg'] w=161 h=161 g=1}" width="161" height="120">{else}<img src="{$TMPL}/images/truntable/img/{$prize[10].img}">{/if}<p><b>{$prize[10].abbrename}</b></p><div class="mask"></div></td>
                <td class="lottery-unit lottery-unit-9">{if isset($prize[9]['showimg'])}<img src="{function name="get_spec_image" v=$prize[9]['showimg'] w=161 h=161 g=1}" width="161" height="120">{else}<img src="{$TMPL}/images/truntable/img/{$prize[9].img}">{/if}<p><b>{$prize[9].abbrename}</b></p><div class="mask"></div></td>
                <td class="lottery-unit lottery-unit-8">{if isset($prize[8]['showimg'])}<img src="{function name="get_spec_image" v=$prize[8]['showimg'] w=161 h=161 g=1}" width="161" height="120">{else}<img src="{$TMPL}/images/truntable/img/{$prize[8].img}">{/if}<p><b>{$prize[8].abbrename}</b></p><div class="mask"></div></td>
                <td class="lottery-unit lottery-unit-7">{if isset($prize[7]['showimg'])}<img src="{function name="get_spec_image" v=$prize[7]['showimg'] w=161 h=161 g=1}" width="161" height="120">{else}<img src="{$TMPL}/images/truntable/img/{$prize[7].img}">{/if}<p><b>{$prize[7].abbrename}</b></p><div class="mask"></div></td>
            </tr>
        </table>
    </div>
    <div class="col-md-4" style="margin-top:40px;">
        <div class="g_3">
            <div class="g_3_tit"><span class="g_3_txt">奖励</span></div>
            <div class="g_3_cet">
                <p style="padding:5px 0px">抽奖花费 : {$actity.expenditure}{$actity.type}</p>
                <table>
                    <tr>
                        <td width="50%">奖品</td>
                        <td width="70%">数量</td>
                    </tr>
                    {foreach from=$prize item=item}
                    <tr>
                        <td>{$item.name}</td>
                        <td>{$item.count}个</td>
                    </tr>
                    {/foreach}
                </table>
            </div>
        </div>
        <div class="g_3">
            <div class="g_3_tit"><span class="g_3_txt">游戏介绍</span></div>
            <div class="g_3_cet1">活动内容：

                <p>1、玩家需要使用自己所有的资源,消耗一定的抽奖花费才能进行幸运轮盘卷进行抽奖，一次抽奖花费只能抽奖一次。</p>

                <p>2、每个ID每天最多只可以抽奖三次。</p>

                <p>3、玩家获得的奖品在60秒后自动加入到账户中</p>
            </div>
        </div>
        <div class="g_3">
            <div class="g_3_tit"><span class="g_3_txt">游戏规则</span></div>
            <div class="g_3_cet1">

                <p>1、先进入兑换中心兑换自己所需的轮盘抽奖卷。</p>

                <p>2、兑换成功后可直接进入幸运轮盘抽奖页面，进行抽奖，也可进入商城，点击“我的背包”的“道具”中查看抽奖卷数据后再进行抽奖。</p>
            </div>
        </div>
    </div>

</div>

</div>


<script>


    var click=false;

    function save (){
        var save_url = APP_ROOT + "/index.php?ctl=turntable&act=save";
        var prize = {$prize_json};
        $prizeid = prize[{$goodluck}].id;
        console.log($prizeid);
        $.ajax({
            url:save_url,
            type:'POST',
            data:{'prizeid':$prizeid},
            success:function(arg){

            }
        })
    }

    function roll(resolve,p){

        if (lottery.times > lottery.cycle+10 && lottery.prize==lottery.index) {
            //中奖的索引
            clearTimeout(lottery.timer);
            lottery.prize=-1;
            lottery.times=0;
            click=false;
            console.log(200,lottery.times,lottery.cycle,lottery.index,lottery.speed);
            var name=$(".lottery-unit-"+{$goodluck}+"").text();
            alert(name);
            // location.reload();
            save();
            resolve(p);
            return;


        }else{
            if (lottery.times<lottery.cycle) {
                lottery.speed -= 10;
            }else if(lottery.times==lottery.cycle) {
                var index ={$goodluck};
                // var index = Math.random()*(lottery.count)|0;//中奖物品通过一个随机数生成
                lottery.prize = index;
            }else{
                if (lottery.times > lottery.cycle+10 && ((lottery.prize==0 && lottery.index==7) || lottery.prize==lottery.index+1)) {
                    lottery.speed += 110;
                }else{
                    lottery.speed += 20;
                }
            }
            if (lottery.speed<40) {
                lottery.speed=40;
            };
            // console.log(lottery.speed)
            lottery.timer = setTimeout(function(){

                roll(resolve,p);

            },lottery.speed);//循环调用
        }
        lottery.times += 1;
        lottery.rolls();//转动过程调用的是lottery的roll方法，这里是第一次调用初始化



    }


    var lottery={
        index:-1,    //当前转动到哪个位置，起点位置
        count:0,    //总共有多少个位置
        timer:0,    //setTimeout的ID，用clearTimeout清除
        speed:5,    //初始转动速度
        times:0,    //转动次数
        cycle:30,    //转动基本次数：即至少需要转动多少次再进入抽奖环节
        prize:-1,    //中奖位置
        init:function(id){
            if ($("#"+id).find(".lottery-unit").length>0) {
                $lottery = $("#"+id);
                $units = $lottery.find(".lottery-unit");
                this.obj = $lottery;
                this.count = $units.length;
                $lottery.find(".lottery-unit-"+this.index).addClass("active");
            };
        },
        //初始化
        rolls:function(){

            var index = this.index;
            var count = this.count;
            var lottery = this.obj;
            $(lottery).find(".lottery-unit-"+index).removeClass("active");
            index += 1;
            if (index>count-1) {
                index = 0;
            };
            $(lottery).find(".lottery-unit-"+index).addClass("active");
            this.index=index;
            return false;
        },
        stop:function(index){
            this.prize=index;
            return false;

        }
    };

    $(function(){

// 第一次调用转盘
        function roll1(p) {

            var promise = new Promise(function (resolve, reject) {

                roll(resolve,p);
            });

            return promise;


        }
// 第2次调用转盘
        function roll2(p){
            var promise = new Promise(function (resolve, reject) {

                roll(resolve,p);
            });

            return promise;
        }
// 第3次调用转盘
        function roll3(p) {
            var promise = new Promise(function (resolve, reject) {

                roll(resolve,p);
            });

            return promise;
        }
// 第4次调用转盘
        function roll4(p) {
            var promise = new Promise(function (resolve, reject) {

                roll(resolve,p);
            });

            return promise;
        }
// 第5次调用转盘
        function roll5(p) {
            var promise = new Promise(function (resolve, reject) {

                roll(resolve,p);
            });

            return promise;
        }


        window.onload=function(){
            var actity = {$actity_json};
            var actityid = actity.id;
            var check_url = APP_ROOT + "/index.php?ctl=turntable&act=check";

            lottery.init('lottery');
            $("#lottery table td a.choujiang-ab").click(function(){
                if (click) {//click控制一次抽奖过程中不能重复点击抽奖按钮，后面的点击不响应
                    return false;
                }else{
                    //传送id判断是否登录等
                    $.ajax({
                        url:check_url,
                        type:'GET',
                        data:{'actityid':actityid},
                        success:function(arg){
                            if(arg.code==200){
                                lottery.speed=100;
                                roll();   //转圈过程不响应click事件，会将click置为false
                                click=true; //一次抽奖完成后，设置click为true，可继续抽奖
                                return false;
                            }else if(arg.code==500){
                                alert(arg.msg);
                                return ;
                            }
                        }
                    })

                }
            });
            $("#lottery table td a.choujiang-ac").click(function(){
                if (click) {//click控制一次抽奖过程中不能重复点击抽奖按钮，后面的点击不响应
                    return false;
                }else{
                    //传送id判断是否登录等
                    $.ajax({
                        url:check_url,
                        type:'GET',
                        data:{'actityid':actityid,'num':5},
                        success:function(arg){
                            if(arg.code==200){
                                roll1(1)
                                    .then(function(res){
                                        console.log(res);
                                        return roll2(2);
                                    })
                                    .then(function () {
                                        return roll3(3);
                                    })
                                    .then(function () {
                                        return roll4(4);
                                    })
                                    .then(function () {
                                        return roll5(5);
                                    });
                                click=true; //一次抽奖完成后，设置click为true，可继续抽奖
                                return false;

                            }else if(arg.code==500){
                                alert(arg.msg);
                                return ;
                            }
                        }
                    })


                }

            });
        };



    })
</script>
{include file="inc/footer.html"}