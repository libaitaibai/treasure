<?php
$this->_var['pagecss'][] = $this->_var['TMPL_REAL']."/css/weebox.css";
$this->_var['pagecss'][] = $this->_var['TMPL_REAL']."/css/fanweUI.css";
$this->_var['pagecss'][] = $this->_var['TMPL_REAL']."/css/style.css";
$this->_var['pagecss'][] = $this->_var['TMPL_REAL']."/css/color.css";
$this->_var['pagecss'][] = $this->_var['TMPL_REAL']."/css/article.css";
$this->_var['pagecss'][] = $this->_var['TMPL_REAL']."/css/public.css";

$this->_var['pagejs'][] = $this->_var['TMPL_REAL']."/js/utils/jquery-1.6.2.min.js";
$this->_var['pagejs'][] = $this->_var['TMPL_REAL']."/js/utils/jquery.bgiframe.js";
$this->_var['pagejs'][] = $this->_var['TMPL_REAL']."/js/utils/jquery.timer.js";
$this->_var['pagejs'][] = $this->_var['TMPL_REAL']."/js/utils/jquery.weebox.js";
$this->_var['pagejs'][] = $this->_var['TMPL_REAL']."/js/utils/jquery.touchwipe.js";
$this->_var['pagejs'][] = $this->_var['TMPL_REAL']."/js/utils/fastclick.js";
$this->_var['pagejs'][] = $this->_var['TMPL_REAL']."/js/utils/TouchSlide.1.1.js";

$this->_var['pagejs'][] = $this->_var['TMPL_REAL']."/js/fanwe_utils/fanweUI.js";
$this->_var['cpagejs'][] = $this->_var['TMPL_REAL']."/js/fanwe_utils/fanweUI.js";

$this->_var['pagejs'][] = $this->_var['TMPL_REAL']."/js/script.js";
$this->_var['cpagejs'][] = $this->_var['TMPL_REAL']."/js/script.js";

$this->_var['pagecss'][] = $this->_var['TMPL_REAL']."/css/styletrun.css";
$this->_var['pagejs'][] = $this->_var['TMPL_REAL']."/js/utils/jquery-1.11.0.min.js";
$this->_var['pagejs'][] = $this->_var['TMPL_REAL']."/js/awardRotate.js";


$this->_var['pagejs'][] = $this->_var['TMPL_REAL']."/js/jquery.eraser.js";

?>
{include file="inc/header_title_home.html"}
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>

    #lottery{margin:0px auto;border:4px solid #ba1809;padding:10px 10px 10px 10px;background-image:url({$TMPL}/images/truntable/img/timg3.jpg);}
    #lottery table{width:100%;}
    #lottery table td{position:relative;width:50px;height:70px;text-align:center;color:#333;font-index:-999;
        /*background:url("./img/back.jpg");*/
    }
    #lottery table td p{
        /*font-size: 1vw;*/

        color: rgb(255, 164, 133);
        margin: 0px;

    }
    #lottery table td img{display:block;width:85%;}
    #lottery table td a{width:60px;height:60px;display:block;text-decoration:none;}
    #lottery table td a:hover{background-image:url({$TMPL}/images/truntable/img/11.jpg);}
    #lottery table td a.choujiang-ab:hover{background-image:url({$TMPL}/images/truntable/img//11y.jpg);}
    #lottery table td a.choujiang-ac:hover{background-image:url({$TMPL}/images/truntable/img//11wu.jpg);}
    #lottery table td.active .mask{display:block;}
    #lottery table td.choujiang-a{
        /*width:50px;*/
        /*height:35px;*/
        position:relative;
        /*left:10px;*/

    }
    #lottery table td a.choujiang-ab{
        width:95%;
        height:40%;
        position:absolute;
        left:20%;
        top:50%;
        background:url({$TMPL}/images/truntable/img/9y.jpg) no-repeat top center;

        background-size:100%;


    }
    #lottery table td a.choujiang-ac{
        width:47%;
        height:40%;
        position:absolute;
        left:35%;
        top:50%;
        background:url({$TMPL}/images/truntable/img/9wu.jpg) no-repeat top center;
        background-size:100%;
    }
    .mask{
        width:100%;
        height:100%;
        position:absolute;
        left:0;
        top:0;
        background-color: rgba(252,211,4,0.5);
        display:none;
    }
    .container{
        width: 95%;
        height: 95%;
        margin-top: 0px;
    }
    @media screen and (min-width: 320px) {
        html {font-size: 10px;}
    }

    @media screen and (min-width: 360px) {
        html {font-size: 12px;}
    }

    @media screen and (min-width: 400px) {
        html {font-size: 13px;}
    }

    @media screen and (min-width: 440px) {
        html {font-size: 20px;}
    }

    @media screen and (min-width: 480px) {
        html {font-size: 22px;}
    }

    @media screen and (min-width: 640px) {
        html {font-size: 24px;}
    }
</style>

<div class="container">
    <div class="row">
        <div class="col-xs-12 "><div class="wrap">

            <select class="box" onchange="window.location=this.value">
                {foreach from=$list.actitys item=item}
                {if $item.id eq $list.actityid}
                <option selected=true value="{url r="index" b="turntable#index"  }&actityid={$item.id}">{$item.name}</option>
                {else}
                <option value="{url r="index" b="turntable#index"  }&actityid={$item.id}">{$item.name}</option>
                {/if}
                {/foreach}
            </select>
            <div class="content">
                <div id="lottery">
                    <table border="0" cellpadding="0" cellspacing="0">
                        <tr>
                            <td class="lottery-unit lottery-unit-0">{if isset($list.prize[0]['showimg'])}<img src="{function name="get_spec_image" v=$list.prize[0]['showimg'] w=161 h=120 g=1}" >{else}<img src="{$TMPL}/images/truntable/img/{$list.prize[0].img}">{/if}<p><b>{$list.prize[0].abbrename}</b></p><div class="mask"></div></td>
                            <td class="lottery-unit lottery-unit-1">{if isset($list.prize[1]['showimg'])}<img src="{function name="get_spec_image" v=$list.prize[1]['showimg'] w=161 h=120 g=1}" >{else}<img src="{$TMPL}/images/truntable/img/{$list.prize[1].img}">{/if}<p><b>{$list.prize[1].abbrename}</b></p><div class="mask"></div></td>
                            <td class="lottery-unit lottery-unit-2">{if isset($list.prize[2]['showimg'])}<img src="{function name="get_spec_image" v=$list.prize[2]['showimg'] w=161 h=120 g=1}" >{else}<img src="{$TMPL}/images/truntable/img/{$list.prize[2].img}">{/if}<p><b>{$list.prize[2].abbrename}</b></p><div class="mask"></div></td>
                            <td class="lottery-unit lottery-unit-3">{if isset($list.prize[3]['showimg'])}<img src="{function name="get_spec_image" v=$list.prize[3]['showimg'] w=161 h=120 g=1}" >{else}<img src="{$TMPL}/images/truntable/img/{$list.prize[3].img}">{/if}<p><b>{$list.prize[3].abbrename}</b></p><div class="mask"></div></td>
                            <td class="lottery-unit lottery-unit-4">{if isset($list.prize[4]['showimg'])}<img src="{function name="get_spec_image" v=$list.prize[4]['showimg'] w=161 h=120 g=1}" >{else}<img src="{$TMPL}/images/truntable/img/{$list.prize[4].img}">{/if}<p><b>{$list.prize[4].abbrename}</b></p><div class="mask"></div></td>
                        </tr>
                        <tr>
                            <td class="lottery-unit lottery-unit-13">{if isset($list.prize[13]['showimg'])}<img src="{function name="get_spec_image" v=$list.prize[13]['showimg'] w=161 h=120 g=1}" >{else}<img src="{$TMPL}/images/truntable/img/{$list.prize[13].img}">{/if}<p><b>{$list.prize[13].abbrename}</b></p><div class="mask"></div></td>
                            <td colspan="1" rowspan="2" class="choujiang-a"><a href="#" class="choujiang-ab"></a></td>
                            <td colspan="2" rowspan="2" class="choujiang-a"><a href="#" class="choujiang-ac"></a></td>
                            <td class="lottery-unit lottery-unit-5">{if isset($list.prize[5]['showimg'])}<img src="{function name="get_spec_image" v=$list.prize[5]['showimg'] w=161 h=120 g=1}" >{else}<img src="{$TMPL}/images/truntable/img/{$list.prize[5].img}">{/if}<p><b>{$list.prize[5].abbrename}</b></p><div class="mask"></div></td>
                        </tr>
                        <tr>
                            <td class="lottery-unit lottery-unit-12">{if isset($list.prize[12]['showimg'])}<img src="{function name="get_spec_image" v=$list.prize[12]['showimg'] w=161 h=120 g=1}">{else}<img src="{$TMPL}/images/truntable/img/{$list.prize[12].img}">{/if}<p><b>{$list.prize[12].abbrename}</b></p><div class="mask"></div></td>
                            <td class="lottery-unit lottery-unit-6">{if isset($list.prize[6]['showimg'])}<img src="{function name="get_spec_image" v=$list.prize[6]['showimg'] w=161 h=120 g=1}" >{else}<img src="{$TMPL}/images/truntable/img/{$list.prize[6].img}">{/if}<p><b>{$list.prize[6].abbrename}</b></p><div class="mask"></div></td>
                        </tr>
                        <tr>
                            <td class="lottery-unit lottery-unit-11">{if isset($list.prize[11]['showimg'])}<img src="{function name="get_spec_image" v=$list.prize[11]['showimg'] w=161 h=120 g=1}">{else}<img src="{$TMPL}/images/truntable/img/{$list.prize[11].img}">{/if}<p><b>{$list.prize[11].abbrename}</b></p><div class="mask"></div></td>
                            <td class="lottery-unit lottery-unit-10">{if isset($list.prize[10]['showimg'])}<img src="{function name="get_spec_image" v=$list.prize[10]['showimg'] w=161 h=120 g=1}">{else}<img src="{$TMPL}/images/truntable/img/{$list.prize[10].img}">{/if}<p><b>{$list.prize[10].abbrename}</b></p><div class="mask"></div></td>
                            <td class="lottery-unit lottery-unit-9">{if isset($list.prize[9]['showimg'])}<img src="{function name="get_spec_image" v=$list.prize[9]['showimg'] w=161 h=120 g=1}">{else}<img src="{$TMPL}/images/truntable/img/{$list.prize[9].img}">{/if}<p><b>{$list.prize[9].abbrename}</b></p><div class="mask"></div></td>
                            <td class="lottery-unit lottery-unit-8">{if isset($list.prize[8]['showimg'])}<img src="{function name="get_spec_image" v=$list.prize[8]['showimg'] w=161 h=120 g=1}">{else}<img src="{$TMPL}/images/truntable/img/{$list.prize[8].img}">{/if}<p><b>{$list.prize[8].abbrename}</b></p><div class="mask"></div></td>
                            <td class="lottery-unit lottery-unit-7">{if isset($list.prize[7]['showimg'])}<img src="{function name="get_spec_image" v=$list.prize[7]['showimg'] w=161 h=120 g=1}">{else}<img src="{$TMPL}/images/truntable/img/{$list.prize[7].img}">{/if}<p><b>{$list.prize[7].abbrename}</b></p><div class="mask"></div></td>
                        </tr>
                    </table>
                </div>
                <div class="col-md-4" style="margin-top:20px;">
                    <div class="g_3">
                        <div class="g_3_tit"><span class="g_3_txt">奖励</span></div>
                        <div class="g_3_cet">
                            <p>抽奖花费 : {$list.actity.expenditure}{$list.actity.type_source}</p>
                            <table>
                                <tr>
                                    <td width="50%">奖品</td>
                                    <td width="70%">数量</td>
                                </tr>
                                {foreach from=$list.prize item=item}
                                <tr>
                                    <td>{$item.name}</td>
                                    <td>{$item.count}个</td>
                                </tr>
                                {/foreach}
                            </table>
                        </div>
                    </div>
                    <div class="g_3">
                        <div class="g_3_tit"><span class="g_3_txt">游戏介绍</span></div>
                        <div class="g_3_cet1">活动内容：

                            <p>1、玩家需要使用自己所有的资源,消耗一定的抽奖花费才能进行幸运轮盘卷进行抽奖，一次抽奖花费只能抽奖一次。</p>

                            <p>2、每个ID每天最多只可以抽奖三次。</p>

                            <p>3、玩家获得的奖品在60秒后自动加入到账户中</p>
                        </div>
                    </div>
                    <div class="g_3">
                        <div class="g_3_tit"><span class="g_3_txt">游戏规则</span></div>
                        <div class="g_3_cet1">

                            <p>1、先进入兑换中心兑换自己所需的轮盘抽奖卷。</p>

                            <p>2、兑换成功后可直接进入幸运轮盘抽奖页面，进行抽奖，也可进入商城，点击“我的背包”的“道具”中查看抽奖卷数据后再进行抽奖。</p>
                        </div>
                    </div>

                </div>
            </div>
        </div>
        </div>


    </div>
</div>

<script>


    var click=false;

    function save (){
        var save_url = APP_ROOT + "/index.php?ctl=turntable&act=save";
        var prize = {$list.prize_json};
        console.log( $prizeid);

        $prizeid = prize[{$list.goodluck}].id;
        $.ajax({
            url:save_url,
            type:'POST',
            data:{'prizeid':$prizeid},
            success:function(arg){

            }
        })
    }

    function roll(resolve,p){

        if (lottery.times > lottery.cycle+10 && lottery.prize==lottery.index) {
            //中奖的索引
            clearTimeout(lottery.timer);
            lottery.prize=-1;
            lottery.times=0;
            click=false;
            console.log(200,lottery.times,lottery.cycle,lottery.index,lottery.speed);
            var name=$(".lottery-unit-"+{$list.goodluck}+"").text();
            alert(name);
            // location.reload();
            save();
            resolve(p);
            return;


        }else{
            if (lottery.times<lottery.cycle) {
                lottery.speed -= 10;
            }else if(lottery.times==lottery.cycle) {
                var index ={$list.goodluck};
                // var index = Math.random()*(lottery.count)|0;//中奖物品通过一个随机数生成
                lottery.prize = index;
            }else{
                if (lottery.times > lottery.cycle+10 && ((lottery.prize==0 && lottery.index==7) || lottery.prize==lottery.index+1)) {
                    lottery.speed += 110;
                }else{
                    lottery.speed += 20;
                }
            }
            if (lottery.speed<40) {
                lottery.speed=40;
            };
            // console.log(lottery.speed)
            lottery.timer = setTimeout(function(){

                roll(resolve,p);

            },lottery.speed);//循环调用
        }
        lottery.times += 1;
        lottery.rolls();//转动过程调用的是lottery的roll方法，这里是第一次调用初始化



    }


    var lottery={
        index:-1,    //当前转动到哪个位置，起点位置
        count:0,    //总共有多少个位置
        timer:0,    //setTimeout的ID，用clearTimeout清除
        speed:5,    //初始转动速度
        times:0,    //转动次数
        cycle:30,    //转动基本次数：即至少需要转动多少次再进入抽奖环节
        prize:-1,    //中奖位置
        init:function(id){
            if ($("#"+id).find(".lottery-unit").length>0) {
                $lottery = $("#"+id);
                $units = $lottery.find(".lottery-unit");
                this.obj = $lottery;
                this.count = $units.length;
                $lottery.find(".lottery-unit-"+this.index).addClass("active");
            };
        },
        //初始化
        rolls:function(){

            var index = this.index;
            var count = this.count;
            var lottery = this.obj;
            $(lottery).find(".lottery-unit-"+index).removeClass("active");
            index += 1;
            if (index>count-1) {
                index = 0;
            };
            $(lottery).find(".lottery-unit-"+index).addClass("active");
            this.index=index;
            return false;
        },
        stop:function(index){
            this.prize=index;
            return false;

        }
    };

    $(function(){

// 第一次调用转盘
        function roll1(p) {

            var promise = new Promise(function (resolve, reject) {

                roll(resolve,p);
            });

            return promise;


        }
// 第2次调用转盘
        function roll2(p){
            var promise = new Promise(function (resolve, reject) {

                roll(resolve,p);
            });

            return promise;
        }
// 第3次调用转盘
        function roll3(p) {
            var promise = new Promise(function (resolve, reject) {

                roll(resolve,p);
            });

            return promise;
        }
// 第4次调用转盘
        function roll4(p) {
            var promise = new Promise(function (resolve, reject) {

                roll(resolve,p);
            });

            return promise;
        }
// 第5次调用转盘
        function roll5(p) {
            var promise = new Promise(function (resolve, reject) {

                roll(resolve,p);
            });

            return promise;
        }



        function check (){

        }
        window.onload=function(){
            var actity = {$list.actity_json};
            var actityid = actity.id;
            var check_url = APP_ROOT + "/index.php?ctl=turntable&act=check";

            lottery.init('lottery');
            $("#lottery table td a.choujiang-ab").click(function(){
                if (click) {//click控制一次抽奖过程中不能重复点击抽奖按钮，后面的点击不响应
                    return false;
                }else{
                    //传送id判断是否登录等
                    $.ajax({
                        url:check_url,
                        type:'GET',
                        data:{'actityid':actityid},
                        success:function(arg){
                            if(arg.code==200){
                                lottery.speed=100;
                                roll();   //转圈过程不响应click事件，会将click置为false
                                click=true; //一次抽奖完成后，设置click为true，可继续抽奖
                                return false;
                            }else if(arg.code==500){
                                alert(arg.msg);
                                return ;
                            }
                        }
                    })

                }
            });
            $("#lottery table td a.choujiang-ac").click(function(){
                if (click) {//click控制一次抽奖过程中不能重复点击抽奖按钮，后面的点击不响应
                    return false;
                }else{
                    // lottery.speed=100;
                    // roll1().then(function(){
                    //     return roll1();
                    // });
                    //传送id判断是否登录等
                    $.ajax({
                        url:check_url,
                        type:'GET',
                        data:{'actityid':actityid},
                        success:function(arg){
                            if(arg.code==200){
                                roll1(1)
                                    .then(function(res){
                                        console.log(res);
                                        return roll2(2);
                                    })
                                    .then(function () {
                                        return roll3(3);
                                    })
                                    .then(function () {
                                        return roll4(4);
                                    })
                                    .then(function () {
                                        return roll5(5);
                                    });
                                // roll();
                                // roll().then(roll());    //转圈过程不响应click事件，会将click置为false
                                click=true; //一次抽奖完成后，设置click为true，可继续抽奖
                                // console.log("aaa");
                                // location.reload();
                                return false;

                            }else if(arg.code==500){
                                alert(arg.msg);
                                return ;
                            }
                        }
                    })


                }

            });
        };

        (function (width) {
            var doc = width.document,
                element = doc.documentElement,
                i = 640,
                d = i / 100,
                o = "orientationchange" in width ? "orientationchange" : "resize",
                a = function () {
                    var width = element.clientWidth || 320;
                    width > 640 && (width = 640);
                    element.style.fontSize = width / d + "px"
                };
            doc.addEventListener && (width.addEventListener(o, a, !1), doc.addEventListener("DOMContentLoaded", a, !1))
        })(window);

    })
</script>

{include file="inc/footer_menu.html"}
{include file="inc/footer_index.html"}