<?php
//刮刮乐静态资源
$this->_var['pagecss'][] = $this->_var['TMPL_REAL']."/css/weebox.css";
$this->_var['pagecss'][] = $this->_var['TMPL_REAL']."/css/fanweUI.css";
$this->_var['pagecss'][] = $this->_var['TMPL_REAL']."/css/style.css";
$this->_var['pagecss'][] = $this->_var['TMPL_REAL']."/css/color.css";
$this->_var['pagecss'][] = $this->_var['TMPL_REAL']."/css/article.css";
$this->_var['pagecss'][] = $this->_var['TMPL_REAL']."/css/public.css";
$this->_var['pagecss'][] = $this->_var['TMPL_REAL']."/css/scratch/normalize.css";
$this->_var['pagecss'][] = $this->_var['TMPL_REAL']."/css/scratch/htmleaf-demo.css";
$this->_var['pagecss'][] = $this->_var['TMPL_REAL']."/css/scratch/style.css";


$this->_var['pagejs'][] = $this->_var['TMPL_REAL']."/js/utils/jquery-1.6.2.min.js";
$this->_var['pagejs'][] = $this->_var['TMPL_REAL']."/js/utils/jquery.bgiframe.js";
$this->_var['pagejs'][] = $this->_var['TMPL_REAL']."/js/utils/jquery.timer.js";
$this->_var['pagejs'][] = $this->_var['TMPL_REAL']."/js/utils/jquery.weebox.js";
$this->_var['pagejs'][] = $this->_var['TMPL_REAL']."/js/utils/fastclick.js";



$this->_var['pagejs'][] = $this->_var['TMPL_REAL']."/js/utils/jquery.mobile-1.2.1.min.js";

$this->_var['pagejs'][] = $this->_var['TMPL_REAL']."/js/fanwe_utils/fanweUI.js";
$this->_var['cpagejs'][] = $this->_var['TMPL_REAL']."/js/fanwe_utils/fanweUI.js";

$this->_var['pagejs'][] = $this->_var['TMPL_REAL']."/js/script.js";
$this->_var['cpagejs'][] = $this->_var['TMPL_REAL']."/js/script.js";



$this->_var['pagejs'][] = $this->_var['TMPL_REAL']."/js/jquery.eraser.js";

?>
{include file="inc/header_title_home.html"}
<style type="text/css">

    #mask_img_bg{

        background-image:url('{$TMPL}/images/scratch/img/scratch_bg.jpg');
        background-size:285px auto;
        background-position:center;
        background-repeat:no-repeat;
        position: absolute;
        left: 0px;
        right: 0px;
        top: 0px;
        bottom: 0px;
    }

    .cont-span{
        display:block;
        width:100%;
        height:100%;
        background-size:285px auto;
        background-position:center;
        background-repeat:no-repeat;

    }
</style>
<div class="wrap_full_w clearfix" style="margin-top:20px">

    {if $rows}
    <div style="width:1040px;height:30px;margin:0 auto">

        <select name="scratch_list" id="" style="width:120px;height:30px">
            {foreach from=$rows item=row}
            <option value="{$row.id}" {if $row.id eq $scratch_id}selected="selected"{/if}>{$row.name}</option>
            {/foreach}
        </select>
    </div>
    {/if}

<div class="htmleaf-container">
    <figure id="bridgeContainer" >
        <!--<canvas id="bridge" width="750" height="465"></canvas>-->
        <div class="redux_c" style="width:285px;height:145px;position:relative;z-index:20;margin: 0 auto;background-size: cover;width: 100%;">
            <div id="mask_img_bg"><span class="cont-span"></span></div>
            <img id="redux" src="{$TMPL}/images/scratch/img/layer.png"/>
        </div>
        <div style="display:none;height:30px;line-height:30px;cursor:pointer;color:#fff;font-weight:bold" id="gua_again">再刮一次</div>

    </figure>


</div>
<div class="text1" style="height:66px">刮刮中大奖</div>

<div class="col-md-4">

    <div class="g_3">
        <div class="g_3_tit"><span class="g_3_txt">奖励设置</span>
            <input type="hidden" name="scratch_tip" value="{$scratch_tip}">
            <input type="hidden" name="scratch_id" value="{$scratch_id}">
        </div>
        <div class="g_3_cet">
            <table>

                <tr>
                    <td width="35%">奖级</td>
                    <td width="65s%">奖品</td>
                </tr>
                {if $prizes}
                {foreach from=$prizes item=prize key=key}
                <tr>
                    <td style="font-size:14px">{$key}</td>
                    <td style="font-size:13px">
                        {foreach from=$prize item=v}
                          <p>{$v}</p>
                        {/foreach}
                    </td>
                </tr>
                {/foreach}
                {else}
                <tr>
                    <td colspan="2" align="center">暂无奖项设置</td>
                </tr>
                {/if}
            </table>
        </div>
    </div>

    <div class="g_3">
        <div class="g_3_tit"><span class="g_3_txt">游戏介绍</span></div>
        <div class="g_3_cet1">刮开页面“请开始刮奖”区域，凡出现××等奖字样即为中奖。</div>
    </div>
    <div class="g_3">
        <div class="g_3_tit"><span class="g_3_txt">游戏规则</span></div>
        <div class="g_3_cet1">刮刮乐会消耗用户的金币，钻石或者优惠券，具体根据每个游戏设定不同。如果玩家中了虚拟货币如金币钻石等，会自动充值到到玩家账号, 用户可以去用户中心查看；如果是实物商品会自动生成订单，用户可以去购买中心查看。</div>
    </div>

</div>
<script type="text/javascript">

    $(document).ready(function(){


        var num = 1;
        var get_result = APP_ROOT + "/wap/index.php?ctl=scratch&act=get_result",
            user_login = APP_ROOT + "/wap/index.php?ctl=user&act=login",
            user_center = APP_ROOT + "/wap/index.php?ctl=uc_center";
        var scratch_id = $('input[name="scratch_id"]').val();
        var scratch_tip = $('input[name="scratch_tip"]').val();

        function ss() {
            $('#redux').unbind().bind('swipe', function () {

                if (num == 1) {
                    if (!scratch_id) {
                        $.showErr('参数错误');
                        return false;
                    }
                    $.showConfirm('消耗' + scratch_tip + '，是否继续？', function () {

                        num++;
                        $.get(get_result, {scratch_id: scratch_id}, function (xhr) {

                            if (xhr.code != 200) {
                                num = 1;
                                if (xhr.code == 401) {
                                    $.showErr(xhr.msg);
                                    window.location.href = user_login;
                                } else if (xhr.code == 402) {
                                    /*$.showErr(xhr.msg,function(){
                                    window.location.href= user_center;
                                });*/
                                    $.showErr(xhr.msg);
                                } else {
                                    $.showErr(xhr.msg);
                                }
                                return false;
                            }


                            $('#redux').eraser({
                                size: 50,   //设置橡皮擦大小
                                completeRatio: .5, //设置擦除面积比例
                            });


                            var img_url = '{$TMPL}/images/scratch/img/';
                            var w = '140px';
                            switch (xhr.data.prize) {
                                case '特等奖':
                                    img_url += '0.png';
                                    break;
                                case '一等奖':
                                    img_url += '1.png';
                                    break;
                                case '二等奖':
                                    img_url += '2.png';
                                    break;
                                case '三等奖':
                                    img_url += '3.png';
                                    break;
                                case '四等奖':
                                    img_url += '4.png';
                                    break;
                                case '谢谢参与':
                                    img_url += 'xiexie.jpg';
                                    w = '285px';
                                    break;

                                default:
                                    img_url = '';

                            }
                            if (img_url) {
                                $("#mask_img_bg>span").css(
                                    {
                                        backgroundImage: 'url(' + img_url + ')',
                                        backgroundSize: '' + w + ' auto'
                                    });
                            } else {
                                $("#mask_img_bg>span").css(
                                    {
                                        display: 'block',
                                        color: '#fff',
                                        width: '120px',
                                        height: '38px',
                                        textAlign: 'center',
                                        position: 'absolute',
                                        top: '40%',
                                        left: '50%',
                                        marginLeft: '-60px',
                                        zIndex: 10,
                                        fontSize: '30px'
                                    }
                                ).text(xhr.data.prize);
                            }
                            //$("#mask_img_bg>span").text(xhr.data.prize);
                            //显示再刮一次
                            $('#gua_again').show();
                        }, 'json');


                    });

                }

            });

        }

        ss();


        $('#gua_again').bind('click',function(){

            var img_url = "{$TMPL}/images/scratch/img/layer.png";
            var str = '<div id="mask_img_bg">\n' +
                '                <span class="cont-span"></span></div>\n' +
                '            <img id="redux" src="'+img_url+'">';

            $('.redux_c').html(str);
            num = 1;
           ss();

        });


        $('select[name="scratch_list"]').siblings('span').remove();
        $('select[name="scratch_list"]').bind('change',function(){

            var id = $(this).val();
            window.location.href=get_index+id;

        });



    });




    /*var bridge = document.getElementById("bridge"),
        bridgeCanvas = bridge.getContext('2d'),
        brushRadius = (bridge.width / 100) * 5,
        img = new Image();
    if (brushRadius < 50) { brushRadius = 50 }
    img.onload = function(){
        bridgeCanvas.drawImage(img, 0, 0, bridge.width, bridge.height);
    }
    //静态资源位置
    /!*img.loc = '{$TMPL}/images/scratch/img/';
    img.filename = 'scratch-1.jpg';
    if (window.devicePixelRatio >= 2) {
        var nameParts = img.filename.split('.');
        img.src = img.loc + nameParts[0]+"-2x"+"."+nameParts[1];
    } else {
        img.src = img.loc + img.filename;
    }*!/
    function detectLeftButton(event) {
        if ('buttons' in event) {
            return event.buttons === 1;
        } else if ('which' in event) {
            return event.which === 1;
        } else {
            return event.button === 1;
        }
    }
    function getBrushPos(xRef, yRef) {
        var bridgeRect = bridge.getBoundingClientRect();
        return {
            x: Math.floor((xRef-bridgeRect.left)/(bridgeRect.right-bridgeRect.left)*bridge.width),
            y: Math.floor((yRef-bridgeRect.top)/(bridgeRect.bottom-bridgeRect.top)*bridge.height)
        };
    }
    function drawDot(mouseX,mouseY){
        bridgeCanvas.beginPath();
        bridgeCanvas.arc(mouseX, mouseY, brushRadius, 0, 2*Math.PI, true);
        bridgeCanvas.fillStyle = '#000';
        bridgeCanvas.globalCompositeOperation = "destination-out";
        bridgeCanvas.fill();
    }
    bridge.addEventListener("mousemove", function(e) {
        var brushPos = getBrushPos(e.clientX, e.clientY);
        var leftBut = detectLeftButton(e);
        if (leftBut == 1) {
            drawDot(brushPos.x, brushPos.y);
        }
    }, false);
    bridge.addEventListener("touchmove", function(e) {
        e.preventDefault();
        var touch = e.targetTouches[0];
        if (touch) {
            var brushPos = getBrushPos(touch.pageX, touch.pageY);
            drawDot(brushPos.x, brushPos.y);
        }
    }, false);*/
</script>
</div>


{include file="inc/footer_menu.html"}
{include file="inc/footer_index.html"}